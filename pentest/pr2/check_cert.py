import subprocess

def read_domains(filename="Nikolaev_Mikhail_domains.txt"):
    with open(filename, "r", encoding="utf-8") as f:
        domains = [line.strip() for line in f if line.strip()]
    return domains


def check_cert(domain):
    print("\\/"*40)
    print(f"Checking domain {domain}")
    try:
        result = subprocess.check_output(f"openssl s_client -connect {domain}:443 -showcerts < /dev/null", shell=True, stderr=subprocess.DEVNULL).decode()
    except:
        result = ""
    start = result.find("Certificate chain")
    end = result.find("-----BEGIN CERTIFICATE-----")

    if start != -1 and end != -1:
        snippet = result[start:end].strip().split("\n")
        start_snippet = snippet[1].find("O=")
        end_snippet = snippet[1].find(", CN=")
        org = snippet[1][start_snippet:end_snippet].strip()
        print(org)
        cert_time = snippet[-1].strip()
        print(cert_time)
        if org == "O=V Kontakte LLC" or org == "O=VK LLC":
            print(f"\033[92m{domain} IS CORRECT\033[0m")
            return True
        print(f"\033[91m{domain} IS NOT CORRECT\033[0m")
        return False
    else:
        print(f"\033[93m{domain} info not found\033[0m")
        return False


counter = 0
for d in read_domains():
    if check_cert(d)==True:
        counter += 1

print(counter)
